```{r}
setwd("/Users/henrysun_1/Desktop/Duke/PhD 2025-2026/World_Corals")
## update file path
df <- read.csv("Corals_clean.csv")

```

```{r}
library(tidyverse)
library(readr)
library(broom)
library(cowplot)
library(caret)

```

```{r}
set.seed(111)
df_filtered <- df[df$host_phylum != "Cnidaria", ]

pca_fit <- df %>% 
  select(where(is.numeric)) %>% # retain only numeric columns
  prcomp() # do PCA

```

```{r}
pca_fit %>%
  augment(df) %>% # add original dataset back in
  ggplot(aes(.fittedPC1, .fittedPC2, color = host_phylum)) + 
  geom_point(size = 1.5) +
  theme_half_open(12) + background_grid()

```
```{r}
pca_fit %>%
  tidy(matrix = "rotation")

```

```{r}
pca_fit %>%
  tidy(matrix = "eigenvalues")

```
```{r}
pca_fit %>%
  tidy(matrix = "eigenvalues") %>%
  ggplot(aes(PC, percent)) +
  geom_col(fill = "#56B4E9", alpha = 0.8) +
  scale_x_continuous(breaks = 1:9) +
  scale_y_continuous(
    labels = scales::percent_format(),
    expand = expansion(mult = c(0, 0.01))
  ) +
  theme_minimal_hgrid(12)


```
#####################################################################

```{r}
library(tidyverse)
library(dplyr)
library(tibble)
library(stringr)
feature_importance_comparison_df <- read.csv("coral_mets_only/featureimportancenov20.csv")
met_df <- read.csv("~/Desktop/Duke/PhD 2025-2026/World_Corals/Raw Data CSVs/Ty_superset_metabolites_coraldb_updated.csv")

# temp_feature_df <- feature_importance_comparison_df %>%
#   rownames_to_column(var = "metabolite")
feature_importance_comparison_df <- feature_importance_comparison_df %>%
  dplyr::rename(metabolite = Feature)


merged_df <- feature_importance_comparison_df %>%
  inner_join(
    met_df,
    by = "metabolite"
  )

merged_df <- merged_df %>%
  arrange(desc(XGBoost_Importance))

top20 <- merged_df[1:20, ]
top20 <- top20 %>%
  mutate(metabolite = fct_reorder(metabolite, XGBoost_Importance, .desc = TRUE))
```

```{r}
library(RColorBrewer)
# top20 <- merged_df[1:20, ] 
# top20 <- top20 %>%
#   mutate(metabolite = fct_reorder(metabolite, XGBoost_Importance, .desc = TRUE))

ggplot(top20, aes(x=metabolite, y=XGBoost_Importance, fill=npc_number_pathway)) + 
  geom_bar(stat="identity", position="dodge") +
  scale_fill_brewer(palette = "Set2") +
  theme(axis.title.x = element_blank()) +
  theme_classic() +
  labs(
    y = "XGBoost Feature Importance",
    x = "Metabolite",
    fill = "NPC Number Pathway"
  ) +
  scale_y_continuous(
    expand = c(0, 0),  
    limits = c(0, NA) 
  ) +
  theme(
    legend.position = "right",
    # axis.title.x = element_blank(), 
    axis.text.x = element_blank()
    # axis.ticks.x = element_blank()
  )

```

```{r}
merged_df_rf <- merged_df %>%
  arrange(desc(RandomForest_Importance))

top20 <- merged_df_rf[1:20, ] 
top20 <- top20 %>%
  mutate(metabolite = fct_reorder(metabolite, RandomForest_Importance, .desc = TRUE))

ggplot(top20, aes(x=metabolite, y=RandomForest_Importance, fill=npc_number_pathway)) + 
  geom_bar(stat="identity", position="dodge") +
  scale_fill_brewer(palette = "Set2") +
  theme(axis.title.x = element_blank()) +
  theme_classic() +
  labs(
    y = "Random Forest Feature Importance",
    x = "Metabolite",
    fill = "NPC Number Pathway"
  ) +
  scale_y_continuous(
    expand = c(0, 0),  
    limits = c(0, NA) 
  ) +
  theme(
    legend.position = "right",
    # axis.title.x = element_blank(), 
    axis.text.x = element_blank()
    # axis.ticks.x = element_blank()
  )
```

