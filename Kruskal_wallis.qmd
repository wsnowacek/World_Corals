---
title: "Kruskal_wallis"
format: html
---

## Library and Data

```{r}
#| label: load_packages

install.packages("tidyverse")
install.packages("rstatix")
install.packages("ggpubr")
```

```{r}
#| lable: library

library(tidyverse)
library(rstatix)
library(ggpubr)
library(knitr)
library(readxl)
library(data.table)
library(vegan)
```

```{r}
#| label: read_csvs

Corals_clean <- read.csv("/Users/ellaandonov/World_Corals/Cleaned data CSVs/Corals_clean.csv")
ITS2_clean   <- read.csv("/Users/ellaandonov/World_Corals/Cleaned data CSVs/ITS2_clean.csv")
met_summary_coral_only <- read.csv("/Users/ellaandonov/World_Corals/Metabolite Summary Data/met_summary_coral_only.csv")
```

## **Richness Kruskal wallis test:**

```{r}
#| label: set_up_richness_metric

#Identify metabolite columns (start with "x")
metabolite_cols <- grep("^x", names(Corals_clean), value = TRUE)

# Compute metabolomic richness per sample
# Richness = count of metabolites with intensity > 0
kw_richness <- Corals_clean %>%
  select(sample_id, host_phylum, location, bleaching, symbiont.potential, all_of(metabolite_cols)) %>%
  rowwise() %>%
  mutate(MetabolomicRichness = sum(c_across(all_of(metabolite_cols)) > 0, na.rm = TRUE)) %>%
  ungroup()

#brought richness column to front for vizualization 
kw_richness <- kw_richness %>% select(MetabolomicRichness, everything())

```

```{r}
#| label: kw_test_richness_by_phylum

kruskal.test(host_phylum ~ MetabolomicRichness, data = kw_richness)
```

```{r}
#| label: kw_test_richness_by_location

kruskal.test(location ~ MetabolomicRichness, data = kw_richness)
```

```{r}
#| label: kw_test_richness_by_bleaching

kruskal.test(bleaching ~ MetabolomicRichness, data = kw_richness)
```

```{r}
#| label: kw_test_richness_by_symbiont_potential

kruskal.test(symbiont.potential ~ MetabolomicRichness, data = kw_richness)
```

-   **Results:** No significant difference was found in the metabolomic richness (number of metabolites present) between different phyla, locations, corals with different bleaching status, or their symbiont.

-   **Null hypothesis (H₀):** The number of metabolites are not significantly different across metadata groups, meaning the population medians are not significantly different.

    -   p-value \> 0.05, failed to reject H₀ → no evidence that groups differ.

## **Entropy Kruskal wallis test:**

```{r}
#| label: entropy_formula_setup

shannon_index <- function(counts, assume_proportions = FALSE, log_base = exp(1)) {
  # remove NAs and non-positive values
  counts <- counts[!is.na(counts) & counts > 0]
  if (length(counts) == 0) return(0)

  if (!assume_proportions) {
    total <- sum(counts)
    if (total == 0) return(0)
    p <- counts / total
  } else {
    p <- counts / sum(counts)  # if already proportions, this will still normalize safely
  }

  -sum(p * log(p, base = log_base))
  }

# identify metabolite columns (start with "x")
metabolite_cols <- grep("^x", names(Corals_clean), value = TRUE)

# calculate metabolic entropy per sample
kw_entropy <- Corals_clean %>%
  select(sample_id, host_phylum, location, bleaching, symbiont.potential, all_of (metabolite_cols)) %>%
  rowwise() %>%
  mutate(MetabolicEntropy = shannon_index(c_across(all_of(metabolite_cols)))) %>%
  ungroup()

#brought richness column to front for vizualization 
kw_entropy <- kw_entropy %>% select(MetabolicEntropy, everything())
```

```{r}
#| label: kw_test_entropy_by_phylum

kruskal.test(host_phylum ~ MetabolicEntropy, data = kw_entropy)
```

```{r}
#| label: kw_test_entropy_by_location

kruskal.test(location ~ MetabolicEntropy, data = kw_entropy)
```

```{r}
#| label: kw_test_entropy_by_bleaching

kruskal.test(bleaching ~ MetabolicEntropy, data = kw_entropy)
```

```{r}
#| label: kw_test_entropy_by_symbiont_potential

kruskal.test(symbiont.potential ~ MetabolicEntropy, data = kw_entropy)
```

-   **Results:** No significant difference was found in the metabolomic entropy between different phyla, locations, corals with different bleaching status, or their symbiont.

-   **Null hypothesis (H₀):** The diversity of metabolites are not significantly different across metadata groups, meaning the population medians are not significantly different.

    -   p-value \> 0.05, failed to reject H₀ → no evidence that groups differ.

## **Evenness Kruskal wallis test:**

```{r}
#| label: evenness_formula_setup

shannon_index <- function(counts, assume_proportions = FALSE, log_base = exp(1)) {
  # remove NAs and non-positive values
  counts <- counts[!is.na(counts) & counts > 0]
  if (length(counts) == 0) return(0)

  if (!assume_proportions) {
    total <- sum(counts)
    if (total == 0) return(0)
    p <- counts / total
  } else {
    p <- counts / sum(counts)  # if already proportions, this will still normalize safely
  }

  -sum(p * log(p, base = log_base))
  }

# 1) Identify metabolite columns
metabolite_cols <- grep("^x", names(Corals_clean), value = TRUE)

# 2) Compute Shannon, Richness, and Evenness per sample
kw_evenness <- Corals_clean %>%
  select(sample_id, host_phylum, location, bleaching, symbiont.potential, all_of(metabolite_cols)) %>%
  rowwise() %>%
  mutate(
    Richness = sum(c_across(all_of(metabolite_cols)) > 0, na.rm = TRUE),
    Shannon  = shannon_index(c_across(all_of(metabolite_cols))),
    Evenness = ifelse(Richness > 1, Shannon / log(Richness), 0)
  ) %>%
  ungroup()


#brought richness column to front for vizualization 
kw_evenness <- kw_evenness %>% select(Evenness, everything())
```

```{r}
#| label: kw_test_evenness_by_phylum

kruskal.test(host_phylum ~ Evenness, data = kw_evenness)
```

```{r}
#| label: kw_test_evenness_by_location

kruskal.test(location ~ Evenness, data = kw_evenness)
```

```{r}
#| label: kw_test_evenness_by_bleaching

kruskal.test(bleaching ~ Evenness, data = kw_evenness)
```

```{r}
#| label: kw_test_evenness_by_symbiont_potential

kruskal.test(symbiont.potential ~ Evenness, data = kw_evenness)
```
