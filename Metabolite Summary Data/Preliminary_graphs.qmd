---
title: "Preliminary_graphs"
format: html
editor: visual
---

## Library and Data

```{r}
# install.packages("randomForest")
# install.packages("vegan")
```

```{r}
#| label: library_function 

library(tidyverse)
library(knitr)
library(readxl)
library(data.table)
library(vegan)
library(scales)
```

```{r}
#| label: read_csvs

Corals_clean <- read.csv("/Users/ellaandonov/World_Corals/Cleaned data CSVs/Corals_clean.csv")
ITS2_clean   <- read.csv("/Users/ellaandonov/World_Corals/Cleaned data CSVs/ITS2_clean.csv")
met_summary_coral_only <- read.csv("/Users/ellaandonov/World_Corals/Metabolite Summary Data/met_summary_coral_only.csv")
```

## Unique species graphs

```{r}
#| label: number_of_species_per_Location

# Overall species richness per location (exclude NA)
location_richness <- Corals_clean %>%
  filter(!is.na(location)) %>%
  group_by(location) %>%
  summarise(Richness = n_distinct(host_species), .groups = "drop")

ggplot(location_richness, aes(
  x = factor(location, levels = c("Hawaii", "Sri Lanka", "Cura√ßao", "North Carolina")),
  y = Richness,
  fill = location
)) +
  geom_col() +
  
  # ---- Add number above bars ----
  geom_text(
    aes(label = Richness),
    vjust = -0.4,
    size = 5,
    fontface = "bold"
  ) +
  
  labs(
    title = "Number Species per Location",
    x = "Location",
    y = "Number of Unique Species"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 14),
    axis.text  = element_text(size = 12),
    legend.position = "none"   # hide redundant legend
  ) +
  # expand y-axis so text fits comfortably above bars
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
```

```{r}
#| label: species_per_phylum 

# Overall species richness per host phylum (exclude NA)
phylum_richness <- Corals_clean %>%
  filter(!is.na(host_phylum)) %>%
  group_by(host_phylum) %>%
  summarise(Richness = n_distinct(host_species), .groups = "drop")

# Bar plot, sorted by richness
ggplot(phylum_richness, aes(x = fct_reorder(host_phylum, Richness), 
                            y = Richness, fill = host_phylum)) +
  geom_col() +
  
  # ---- Add number labels above bars ----
  geom_text(
    aes(label = Richness),
    vjust = -0.4,
    size = 5,
    fontface = "bold"
  ) +
  
  scale_fill_brewer(palette = "Dark2") +  # distinct colors
  labs(
    title = "Species per Phylum",
    x = "Phylum",
    y = "Number of Unique Species"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 14),
    axis.text  = element_text(size = 12),
    legend.position = "none"
  ) +
  
  # Give space above bars for the labels
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
```

```{r}
#| label: Species_by_Symbiont_Potential

# Overall species richness per symbiont potential (exclude NA)
symbiont_richness <- Corals_clean %>%
  filter(!is.na(symbiont.potential)) %>%
  group_by(symbiont.potential) %>%
  summarise(Richness = n_distinct(host_species), .groups = "drop")

# Coral-inspired colors (warm pinks, oranges, reds)
coral_colors <- c("#FF7F50", "#FF6347", "#E9967A")

# Bar plot
ggplot(symbiont_richness, aes(x = symbiont.potential, 
                              y = Richness, 
                              fill = symbiont.potential)) +
  geom_col() +
  
  # ------- Add labels above bars -------
  geom_text(
    aes(label = Richness),
    vjust = -0.4,
    size = 5,
    fontface = "bold"
  ) +
  
  scale_fill_manual(values = coral_colors) +
  labs(title = "Species by Symbiont Potential",
       x = "Symbiont Potential",
       y = "Number of Unique Species") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 14),
    axis.text  = element_text(size = 12),
    legend.position = "none"
  ) +
  
  # Give extra space above bars for labels
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
```

```{r}
#| label: Species_by_Bleaching_Status

richness_bleaching <- Corals_clean %>%
  filter(!is.na(bleaching),
         !is.na(host_species),
         host_order == "Scleractinia") %>%   
  group_by(bleaching) %>%
  summarise(Richness = n_distinct(host_species), .groups = "drop") %>%
  mutate(bleaching = factor(bleaching, levels = c("NB", "Pale", "B")))

# Bar plot
ggplot(richness_bleaching, aes(x = bleaching, y = Richness, fill = bleaching)) +
  geom_col(width = 0.7) +
  
  # ---- Add numbers above bars ----
  geom_text(
    aes(label = Richness),
    vjust = -0.4,
    size = 5,
    fontface = "bold"
  ) +
  
  scale_fill_brewer(palette = "Set2") +
  scale_x_discrete(labels = c(
    "NB"   = "Non-bleaching",
    "Pale" = "Pale",
    "B"    = "Bleaching"
  )) +
  labs(
    title = "Amount of Scleractinia by Bleaching Status",
    x = "Bleaching Status",
    y = "Number of Unique Coral species"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title  = element_text(size = 14),
    axis.text   = element_text(size = 12),
    legend.position = "none"
  ) +
  
  # Add some room above bars so labels aren't cut off
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
```

## Richness graphs

```{r}
#| label: Metabolomic_Richness_by_Phylum

# 1) Identify metabolite columns (start with "x")
metabolite_cols <- grep("^x", names(Corals_clean), value = TRUE)

# 2) Compute metabolomic richness per sample
#    Richness = count of metabolites with intensity > 0
richness_df <- Corals_clean %>%
  select(sample_id, host_phylum, all_of(metabolite_cols)) %>%
  rowwise() %>%
  mutate(MetabolomicRichness = sum(c_across(all_of(metabolite_cols)) > 0, na.rm = TRUE)) %>%
  ungroup()

# 3) Build a distinct, readable palette sized to the # of phyla
n_phyla <- n_distinct(na.omit(richness_df$host_phylum))
diverse_palette <- grDevices::colorRampPalette(
  c("#ebf2ff", "#6d9eeb", "#3c78d8",   # blues
    "#a2d9a2", "#3fa34d", "#145214",   # greens
    "#e0c2f2", "#9b59b6", "#4b0082")   # purples
)(n_phyla)

# 4) Box-and-whisker plot (dark background, clear outlines, visible outliers)
ggplot(richness_df, aes(x = host_phylum, y = MetabolomicRichness, fill = host_phylum)) +
  geom_boxplot(color = "white", outlier.colour = "white", outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = diverse_palette) +
  labs(
    title = "Metabolomic Richness by Phylum",
    x = "Phylum",
    y = "Number of Detected Metabolites"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    legend.position   = "none",
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "white"),
    axis.title = element_text(size = 14, color = "white"),
    axis.text  = element_text(size = 12, color = "white"),
    panel.grid.major = element_line(color = "gray40"),
    panel.grid.minor = element_line(color = "gray30")
  )

```

```{r}
#| label: Metabolomic_Richness_by_Symbiont_Potential

# 1) Identify metabolite columns (start with "x")
metabolite_cols <- grep("^x", names(Corals_clean), value = TRUE)

# 2) Compute metabolomic richness per sample
richness_df <- Corals_clean %>%
  select(sample_id, symbiont.potential, all_of(metabolite_cols)) %>%
  rowwise() %>%
  mutate(MetabolomicRichness = sum(c_across(all_of(metabolite_cols)) > 0, na.rm = TRUE)) %>%
  ungroup()

# 3) Build a palette sized to the number of symbiont categories
n_symb <- n_distinct(na.omit(richness_df$symbiont.potential))
diverse_palette <- grDevices::colorRampPalette(
  c("#ebf2ff", "#6d9eeb", "#3c78d8",   # blues
    "#a2d9a2", "#3fa34d", "#145214",   # greens
    "#e0c2f2", "#9b59b6", "#4b0082")   # purples
)(n_symb)

# 4) Box-and-whisker plot
ggplot(richness_df, aes(x = symbiont.potential, y = MetabolomicRichness, fill = symbiont.potential)) +
  geom_boxplot(color = "white", outlier.colour = "white", outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = diverse_palette) +
  labs(
    title = "Metabolomic Richness by Symbiont Potential",
    x = "Symbiont Potential",
    y = "Number of Detected Metabolites"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    legend.position   = "none",
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "white"),
    axis.title = element_text(size = 14, color = "white"),
    axis.text  = element_text(size = 12, color = "white"),
    panel.grid.major = element_line(color = "gray40"),
    panel.grid.minor = element_line(color = "gray30")
  )

```

```{r}
#| label: Metabolomic_Richness_by_Bleaching_Status

# 1) Identify metabolite columns (start with "x")
metabolite_cols <- grep("^x", names(Corals_clean), value = TRUE)

# 2) Compute metabolomic richness per sample
richness_df <- Corals_clean %>%
  select(sample_id, bleaching, all_of(metabolite_cols)) %>%
  rowwise() %>%
  mutate(MetabolomicRichness = sum(c_across(all_of(metabolite_cols)) > 0, na.rm = TRUE)) %>%
  ungroup()

# 3) Build palette sized to bleaching categories
n_bleach <- n_distinct(na.omit(richness_df$bleaching))
diverse_palette <- grDevices::colorRampPalette(
  c("#ebf2ff", "#6d9eeb", "#3c78d8",   # blues
    "#a2d9a2", "#3fa34d", "#145214",   # greens
    "#e0c2f2", "#9b59b6", "#4b0082")   # purples
)(n_bleach)

# 4) Box-and-whisker plot
ggplot(richness_df, aes(x = bleaching, y = MetabolomicRichness, fill = bleaching)) +
  geom_boxplot(color = "white", outlier.colour = "white", outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = diverse_palette) +
  labs(
    title = "Metabolomic Richness by Bleaching Status",
    x = "Bleaching Status",
    y = "Number of Detected Metabolites"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    legend.position   = "none",   # hide legend since x-axis already labeled
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "white"),
    axis.title = element_text(size = 14, color = "white"),
    axis.text  = element_text(size = 12, color = "white"),
    panel.grid.major = element_line(color = "gray40"),
    panel.grid.minor = element_line(color = "gray30")
  )
```

```{r}
#| label: Metabolomic_Richness_by_Bleaching_Status_significance

library(ggsignif)

# y-positions
y_line   <- max(richness_df$MetabolomicRichness) * 1.05
y_text   <- max(richness_df$MetabolomicRichness) * 1.10   # stars ABOVE line
y_pvalue <- max(richness_df$MetabolomicRichness) * 1.00   # p-value BELOW line

ggplot(richness_df, aes(x = bleaching, y = MetabolomicRichness, fill = bleaching)) +
  geom_boxplot(color = "white") +
  scale_fill_manual(values = diverse_palette) +
  
  # significance LINE only
  geom_signif(
    comparisons = list(c("NB", "B")),
    annotations = "",        # prevents numbers behind your ***
    y_position = y_line,
    tip_length = 0.02,
    color = "red",
    size = 1.3
  ) +
  
  # stars ABOVE
  annotate(
    "text",
    x = 1.5,
    y = y_text,
    label = "***",
    color = "white",
    size = 8,
    fontface = "bold"
  ) +
  
  # p-value BELOW (you said it is 0)
  annotate(
    "text",
    x = 1.5,
    y = y_pvalue,
    label = "p < 0.0001",
    color = "white",
    size = 5,
    fontface = "plain"
  ) +
  
  labs(
    title = "Metabolomic Richness by Bleaching Status",
    x = "Bleaching Status",
    y = "Number of Detected Metabolites"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    legend.position   = "none",
    axis.text  = element_text(color = "white"),
    axis.title = element_text(color = "white"),
    plot.title = element_text(color = "white", face = "bold", hjust = 0.5, size = 18)
  )
```

```{r}
#| label: Metabolomic_Richness_by_Location

# 1) Identify metabolite columns (start with "x")
metabolite_cols <- grep("^x", names(Corals_clean), value = TRUE)

# 2) Compute metabolomic richness per sample
richness_df <- Corals_clean %>%
  select(sample_id, location, all_of(metabolite_cols)) %>%
  rowwise() %>%
  mutate(MetabolomicRichness = sum(c_across(all_of(metabolite_cols)) > 0, na.rm = TRUE)) %>%
  ungroup()

# 3) Build palette sized to number of locations
n_loc <- n_distinct(na.omit(richness_df$location))
diverse_palette <- grDevices::colorRampPalette(
  c("#ebf2ff", "#6d9eeb", "#3c78d8",   # blues
    "#a2d9a2", "#3fa34d", "#145214",   # greens
    "#e0c2f2", "#9b59b6", "#4b0082")   # purples
)(n_loc)

# 4) Box-and-whisker plot
ggplot(richness_df, aes(x = location, y = MetabolomicRichness, fill = location)) +
  geom_boxplot(color = "white", outlier.colour = "white", outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = diverse_palette) +
  labs(
    title = "Metabolomic Richness by Location",
    x = "Location",
    y = "Number of Detected Metabolites"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    legend.position   = "none",   # x-axis already labels groups
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "white"),
    axis.title = element_text(size = 14, color = "white"),
    axis.text  = element_text(size = 12, color = "white"),
    panel.grid.major = element_line(color = "gray40"),
    panel.grid.minor = element_line(color = "gray30")
  )

```

## Entropy graphs

```{r}
#| label: Metabolic_Entropy_by_Phylum

# Shannon entropy function
shannon_index <- function(counts) {
  counts <- counts[counts > 0]   # drop zeros
  total <- sum(counts)
  if (total == 0) return(0)      # if no metabolites detected
  p <- counts / total
  -sum(p * log(p))
}

# identify metabolite columns (start with "x")
metabolite_cols <- grep("^x", names(Corals_clean), value = TRUE)

# calculate metabolic entropy per sample
entropy_df <- Corals_clean %>%
  select(sample_id, host_phylum, all_of(metabolite_cols)) %>%
  rowwise() %>%
  mutate(MetabolicEntropy = shannon_index(c_across(all_of(metabolite_cols)))) %>%
  ungroup()

# how many phyla?
n_phyla <- n_distinct(na.omit(entropy_df$host_phylum))

# generate diverse palette (blues, greens, purples)
diverse_palette <- grDevices::colorRampPalette(
  c("#ebf2ff", "#6d9eeb", "#3c78d8",   # blues
    "#a2d9a2", "#3fa34d", "#145214",   # greens
    "#e0c2f2", "#9b59b6", "#4b0082")   # purples
)(n_phyla)

# Boxplot with visible outlines + outliers
ggplot(entropy_df, aes(x = host_phylum, y = MetabolicEntropy, fill = host_phylum)) +
  geom_boxplot(color = "white", outlier.colour = "white", outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = diverse_palette) +
  labs(
    title = "Metabolic Entropy by Phylum",
    x = "Phylum",
    y = "Shannon Diversity of Metabolites"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    legend.position   = "none",   # hide legend
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "white"),
    axis.title = element_text(size = 14, color = "white"),
    axis.text  = element_text(size = 12, color = "white"),
    panel.grid.major = element_line(color = "gray40"),
    panel.grid.minor = element_line(color = "gray30")
  )
```

```{r}
#| label: Metabolic_Entropy_by_Phylum_significance

library(ggsignif)

# --- choose the two phyla to annotate (from Tukey results: Porifera vs Cnidaria was significant)
phylum_a <- "Cnidaria"
phylum_b <- "Porifera"

# ensure factor levels and get numeric x positions for the two phyla
entropy_df$host_phylum <- factor(entropy_df$host_phylum)   # preserve current ordering
lvl <- levels(entropy_df$host_phylum)
x_a <- which(lvl == phylum_a)
x_b <- which(lvl == phylum_b)
x_mid <- mean(c(x_a, x_b))

# compute y positions relative to data range so annotations scale
y_max   <- max(entropy_df$MetabolicEntropy, na.rm = TRUE)
y_min   <- min(entropy_df$MetabolicEntropy, na.rm = TRUE)
y_range <- y_max - y_min

y_line   <- y_max + 0.06 * y_range   # bar slightly above the boxes
y_text   <- y_line    + 0.05 * y_range # stars above the bar
y_pvalue <- y_line    - 0.05 * y_range # p-value below the bar

ggplot(entropy_df, aes(x = host_phylum, y = MetabolicEntropy, fill = host_phylum)) +
  geom_boxplot(color = "white", outlier.colour = "white", outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = diverse_palette) +

  # draw only the yellow significance bar (no numeric annotation from geom_signif)
  geom_signif(
    comparisons = list(c(phylum_a, phylum_b)),
    annotations = "",         # suppress default text (prevents numbers behind stars)
    y_position = y_line,
    tip_length = 0.02,
    color = "red",
    size = 1.3
  ) +

  # stars above the line
  annotate(
    "text",
    x = x_mid,
    y = y_text,
    label = "***",
    color = "white",
    size = 7,
    fontface = "bold"
  ) +

  # Tukey p-value below the line (formatted)
  annotate(
    "text",
    x = x_mid,
    y = y_pvalue,
    label = paste0("p < 0.0001"),
    color = "white",
    size = 4,
    fontface = "plain"
  ) +

  labs(
    title = "Metabolic Entropy by Phylum",
    x = "Phylum",
    y = "Shannon Diversity of Metabolites"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    legend.position   = "none",
    plot.title = element_text(color = "white", face = "bold", hjust = 0.5, size = 18),
    axis.title = element_text(size = 14, color = "white"),
    axis.text  = element_text(size = 12, color = "white"),
    panel.grid.major = element_line(color = "gray40"),
    panel.grid.minor = element_line(color = "gray30")
  )
```

```{r}
#| label: Metabolomic_Entropy_by Symbiont_Potential

# Shannon entropy function
shannon_index <- function(counts) {
  counts <- counts[counts > 0]   # drop zeros (metabolites not detected)
  total <- sum(counts)
  if (total == 0) return(0)      # if no metabolites detected
  p <- counts / total
  -sum(p * log(p))               # Shannon entropy (natural log)
}

# 1) Identify metabolite columns (start with "x")
metabolite_cols <- grep("^x", names(Corals_clean), value = TRUE)

# 2) Compute metabolomic entropy per sample
entropy_df <- Corals_clean %>%
  select(sample_id, symbiont.potential, all_of(metabolite_cols)) %>%
  rowwise() %>%
  mutate(MetabolomicEntropy = shannon_index(c_across(all_of(metabolite_cols)))) %>%
  ungroup()

# 3) Build palette sized to symbiont potential categories
n_symb <- n_distinct(na.omit(entropy_df$symbiont.potential))
diverse_palette <- grDevices::colorRampPalette(
  c("#ebf2ff", "#6d9eeb", "#3c78d8",   # blues
    "#a2d9a2", "#3fa34d", "#145214",   # greens
    "#e0c2f2", "#9b59b6", "#4b0082")   # purples
)(n_symb)

# 4) Box-and-whisker plot
ggplot(entropy_df, aes(x = symbiont.potential, y = MetabolomicEntropy, fill = symbiont.potential)) +
  geom_boxplot(color = "white", outlier.colour = "white", outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = diverse_palette) +
  labs(
    title = "Metabolomic Entropy by Symbiont Potential",
    x = "Symbiont Potential",
    y = "Shannon Diversity of Metabolites"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    legend.position   = "none",   # x-axis labels are enough
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "white"),
    axis.title = element_text(size = 14, color = "white"),
    axis.text  = element_text(size = 12, color = "white"),
    panel.grid.major = element_line(color = "gray40"),
    panel.grid.minor = element_line(color = "gray30")
  )

```

```{r}
#| label: Metabolomic_Entropy_by_Bleaching_Status

# Shannon entropy function
shannon_index <- function(counts) {
  counts <- counts[counts > 0]   # drop zeros (not detected)
  total <- sum(counts)
  if (total == 0) return(0)      # if no metabolites detected
  p <- counts / total
  -sum(p * log(p))               # Shannon entropy (natural log)
}

# 1) Identify metabolite columns (start with "x")
metabolite_cols <- grep("^x", names(Corals_clean), value = TRUE)

# 2) Compute metabolomic entropy per sample
entropy_df <- Corals_clean %>%
  select(sample_id, bleaching, all_of(metabolite_cols)) %>%
  rowwise() %>%
  mutate(MetabolomicEntropy = shannon_index(c_across(all_of(metabolite_cols)))) %>%
  ungroup()

# 3) Build palette sized to bleaching categories
n_bleach <- n_distinct(na.omit(entropy_df$bleaching))
diverse_palette <- grDevices::colorRampPalette(
  c("#ebf2ff", "#6d9eeb", "#3c78d8",   # blues
    "#a2d9a2", "#3fa34d", "#145214",   # greens
    "#e0c2f2", "#9b59b6", "#4b0082")   # purples
)(n_bleach)

# 4) Box-and-whisker plot
ggplot(entropy_df, aes(x = bleaching, y = MetabolomicEntropy, fill = bleaching)) +
  geom_boxplot(color = "white", outlier.colour = "white", outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = diverse_palette) +
  labs(
    title = "Metabolomic Entropy by Bleaching Status",
    x = "Bleaching Status",
    y = "Shannon Diversity of Metabolites"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    legend.position   = "none",   # categories already on x-axis
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "white"),
    axis.title = element_text(size = 14, color = "white"),
    axis.text  = element_text(size = 12, color = "white"),
    panel.grid.major = element_line(color = "gray40"),
    panel.grid.minor = element_line(color = "gray30")
  )

```

```{r}
#| label: Metabolomic_Entropy_by_Location

# Shannon entropy function
shannon_index <- function(counts) {
  counts <- counts[counts > 0]   # drop zeros (not detected)
  total <- sum(counts)
  if (total == 0) return(0)      # if no metabolites detected
  p <- counts / total
  -sum(p * log(p))               # Shannon entropy (natural log)
}

# 1) Identify metabolite columns (start with "x")
metabolite_cols <- grep("^x", names(Corals_clean), value = TRUE)

# 2) Compute metabolomic entropy per sample
entropy_df <- Corals_clean %>%
  select(sample_id, location, all_of(metabolite_cols)) %>%
  rowwise() %>%
  mutate(MetabolomicEntropy = shannon_index(c_across(all_of(metabolite_cols)))) %>%
  ungroup()

# 3) Build palette sized to number of locations
n_loc <- n_distinct(na.omit(entropy_df$location))
diverse_palette <- grDevices::colorRampPalette(
  c("#ebf2ff", "#6d9eeb", "#3c78d8",   # blues
    "#a2d9a2", "#3fa34d", "#145214",   # greens
    "#e0c2f2", "#9b59b6", "#4b0082")   # purples
)(n_loc)

# 4) Box-and-whisker plot
ggplot(entropy_df, aes(x = location, y = MetabolomicEntropy, fill = location)) +
  geom_boxplot(color = "white", outlier.colour = "white", outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = diverse_palette) +
  labs(
    title = "Metabolomic Entropy by Location",
    x = "Location",
    y = "Shannon Diversity of Metabolites"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    legend.position   = "none",   # labels already on x-axis
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "white"),
    axis.title = element_text(size = 14, color = "white"),
    axis.text  = element_text(size = 12, color = "white"),
    panel.grid.major = element_line(color = "gray40"),
    panel.grid.minor = element_line(color = "gray30")
  )

```

## Evenness graphs

```{r}
#| label: Metabolomic_Evenness_by_Phylum

# Shannon entropy function
shannon_index <- function(counts) {
  counts <- counts[counts > 0]   # drop zeros
  total <- sum(counts)
  if (total == 0) return(0)      # no metabolites detected
  p <- counts / total
  -sum(p * log(p))               # Shannon entropy (natural log)
}

# 1) Identify metabolite columns
metabolite_cols <- grep("^x", names(Corals_clean), value = TRUE)

# 2) Compute Shannon, Richness, and Evenness per sample
evenness_df <- Corals_clean %>%
  select(sample_id, host_phylum, all_of(metabolite_cols)) %>%
  rowwise() %>%
  mutate(
    Richness = sum(c_across(all_of(metabolite_cols)) > 0, na.rm = TRUE),
    Shannon  = shannon_index(c_across(all_of(metabolite_cols))),
    Evenness = ifelse(Richness > 1, Shannon / log(Richness), 0)
  ) %>%
  ungroup()

# 3) Build palette sized to number of phyla
n_phyla <- n_distinct(na.omit(evenness_df$host_phylum))
diverse_palette <- grDevices::colorRampPalette(
  c("#ebf2ff", "#6d9eeb", "#3c78d8",   # blues
    "#a2d9a2", "#3fa34d", "#145214",   # greens
    "#e0c2f2", "#9b59b6", "#4b0082")   # purples
)(n_phyla)

# 4) Box-and-whisker plot
ggplot(evenness_df, aes(x = host_phylum, y = Evenness, fill = host_phylum)) +
  geom_boxplot(color = "white", outlier.colour = "white", outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = diverse_palette) +
  labs(
    title = "Metabolomic Evenness by Phylum",
    x = "Phylum",
    y = "Evenness"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    legend.position   = "none",   # no legend needed
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "white"),
    axis.title = element_text(size = 14, color = "white"),
    axis.text  = element_text(size = 12, color = "white"),
    panel.grid.major = element_line(color = "gray40"),
    panel.grid.minor = element_line(color = "gray30")
  )

```

```{r}
#| label: Metabolomic_Evenness_by_Symbiont_Potential

# Shannon entropy function
shannon_index <- function(counts) {
  counts <- counts[counts > 0]   # drop zeros
  total <- sum(counts)
  if (total == 0) return(0)      # no metabolites detected
  p <- counts / total
  -sum(p * log(p))               # Shannon entropy (natural log)
}

# 1) Identify metabolite columns
metabolite_cols <- grep("^x", names(Corals_clean), value = TRUE)

# 2) Compute Shannon, Richness, and Evenness per sample
evenness_df <- Corals_clean %>%
  select(sample_id, symbiont.potential, all_of(metabolite_cols)) %>%
  rowwise() %>%
  mutate(
    Richness = sum(c_across(all_of(metabolite_cols)) > 0, na.rm = TRUE),
    Shannon  = shannon_index(c_across(all_of(metabolite_cols))),
    Evenness = ifelse(Richness > 1, Shannon / log(Richness), 0)
  ) %>%
  ungroup()

# 3) Build palette sized to symbiont categories
n_symb <- n_distinct(na.omit(evenness_df$symbiont.potential))
diverse_palette <- grDevices::colorRampPalette(
  c("#ebf2ff", "#6d9eeb", "#3c78d8",   # blues
    "#a2d9a2", "#3fa34d", "#145214",   # greens
    "#e0c2f2", "#9b59b6", "#4b0082")   # purples
)(n_symb)

# 4) Box-and-whisker plot
ggplot(evenness_df, aes(x = symbiont.potential, y = Evenness, fill = symbiont.potential)) +
  geom_boxplot(color = "white", outlier.colour = "white", outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = diverse_palette) +
  labs(
    title = "Metabolomic Evenness by Symbiont Potential",
    x = "Symbiont Potential",
    y = "Evenness"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    legend.position   = "none",   # categories are on x-axis
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "white"),
    axis.title = element_text(size = 14, color = "white"),
    axis.text  = element_text(size = 12, color = "white"),
    panel.grid.major = element_line(color = "gray40"),
    panel.grid.minor = element_line(color = "gray30")
  )

```

```{r}
#| label: Metabolomic_Evenness_by_Bleaching_Status

# Shannon entropy function
shannon_index <- function(counts) {
  counts <- counts[counts > 0]   # drop zeros
  total <- sum(counts)
  if (total == 0) return(0)      # no metabolites detected
  p <- counts / total
  -sum(p * log(p))               # Shannon entropy (natural log)
}

# 1) Identify metabolite columns
metabolite_cols <- grep("^x", names(Corals_clean), value = TRUE)

# 2) Compute Shannon, Richness, and Evenness per sample
evenness_df <- Corals_clean %>%
  select(sample_id, bleaching, all_of(metabolite_cols)) %>%
  rowwise() %>%
  mutate(
    Richness = sum(c_across(all_of(metabolite_cols)) > 0, na.rm = TRUE),
    Shannon  = shannon_index(c_across(all_of(metabolite_cols))),
    Evenness = ifelse(Richness > 1, Shannon / log(Richness), 0)
  ) %>%
  ungroup()

# 3) Build palette sized to bleaching categories
n_bleach <- n_distinct(na.omit(evenness_df$bleaching))
diverse_palette <- grDevices::colorRampPalette(
  c("#ebf2ff", "#6d9eeb", "#3c78d8",   # blues
    "#a2d9a2", "#3fa34d", "#145214",   # greens
    "#e0c2f2", "#9b59b6", "#4b0082")   # purples
)(n_bleach)

# 4) Box-and-whisker plot
ggplot(evenness_df, aes(x = bleaching, y = Evenness, fill = bleaching)) +
  geom_boxplot(color = "white", outlier.colour = "white", outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = diverse_palette) +
  labs(
    title = "Metabolomic Evenness by Bleaching Status",
    x = "Bleaching Status",
    y = "Evenness"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    legend.position   = "none",   # categories are on x-axis
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "white"),
    axis.title = element_text(size = 14, color = "white"),
    axis.text  = element_text(size = 12, color = "white"),
    panel.grid.major = element_line(color = "gray40"),
    panel.grid.minor = element_line(color = "gray30")
  )
```

```{r}
#| label: Metabolomic_Evenness_by_Bleaching_Status_significant

library(ggsignif)

# positions computed from the data range so they scale nicely
y_max   <- max(evenness_df$Evenness, na.rm = TRUE)
y_min   <- min(evenness_df$Evenness, na.rm = TRUE)
y_range <- y_max - y_min

y_line   <- y_max + 0.05 * y_range   # bar slightly above the boxes
y_text   <- y_line    + 0.05 * y_range # stars above the bar
y_pvalue <- y_line    - 0.05 * y_range # p-value below the bar

ggplot(evenness_df, aes(x = bleaching, y = Evenness, fill = bleaching)) +
  geom_boxplot(color = "white", outlier.colour = "white", outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = diverse_palette) +

  # draw only the red significance bar
  geom_signif(
    comparisons = list(c("NB", "B")),
    annotations = "",         # important: suppress numbers printed by geom_signif
    y_position = y_line,
    tip_length = 0.02,
    color = "red",
    size = 1.3
  ) +

  # stars above the line
  annotate(
    "text",
    x = 1.5,                  # midpoint between NB (1) and B (2)
    y = y_text,
    label = "***",
    color = "white",
    size = 7,
    fontface = "bold"
  ) +

  # Tukey p-value below the line (formatted)
  annotate(
    "text",
    x = 1.5,
    y = y_pvalue,
    label = paste0("p < 0.0001"),
    color = "white",
    size = 4,
    fontface = "plain"
  ) +

  labs(
    title = "Metabolomic Evenness by Bleaching Status",
    x = "Bleaching Status",
    y = "Evenness"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    legend.position   = "none",
    plot.title = element_text(color = "white", face = "bold", hjust = 0.5, size = 18),
    axis.title = element_text(size = 14, color = "white"),
    axis.text  = element_text(size = 12, color = "white"),
    panel.grid.major = element_line(color = "gray40"),
    panel.grid.minor = element_line(color = "gray30")
  )
```

```{r}
#| label: Metabolomic_Evenness_by_Location

# Shannon entropy function
shannon_index <- function(counts) {
  counts <- counts[counts > 0]   # drop zeros
  total <- sum(counts)
  if (total == 0) return(0)      # if no metabolites detected
  p <- counts / total
  -sum(p * log(p))               # Shannon entropy (natural log)
}

# 1) Identify metabolite columns
metabolite_cols <- grep("^x", names(Corals_clean), value = TRUE)

# 2) Compute Shannon, Richness, and Evenness per sample
evenness_df <- Corals_clean %>%
  select(sample_id, location, all_of(metabolite_cols)) %>%
  rowwise() %>%
  mutate(
    Richness = sum(c_across(all_of(metabolite_cols)) > 0, na.rm = TRUE),
    Shannon  = shannon_index(c_across(all_of(metabolite_cols))),
    Evenness = ifelse(Richness > 1, Shannon / log(Richness), 0)
  ) %>%
  ungroup()

# 3) Build palette sized to number of locations
n_loc <- n_distinct(na.omit(evenness_df$location))
diverse_palette <- grDevices::colorRampPalette(
  c("#ebf2ff", "#6d9eeb", "#3c78d8",   # blues
    "#a2d9a2", "#3fa34d", "#145214",   # greens
    "#e0c2f2", "#9b59b6", "#4b0082")   # purples
)(n_loc)

# 4) Box-and-whisker plot
ggplot(evenness_df, aes(x = location, y = Evenness, fill = location)) +
  geom_boxplot(color = "white", 
               outlier.colour = "white", 
               outlier.shape = 16, 
               outlier.size = 2) +
  scale_fill_manual(values = diverse_palette) +
  labs(
    title = "Metabolomic Evenness by Location",
    x = "Location",
    y = "Evenness"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    legend.position   = "none",   # categories already on x-axis
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "white"),
    axis.title = element_text(size = 14, color = "white"),
    axis.text  = element_text(size = 12, color = "white"),
    panel.grid.major = element_line(color = "gray40"),
    panel.grid.minor = element_line(color = "gray30")
  )

```

## Ubiquity abundance graphs

```{r}
#| label: total_Ubiquity_abundance_graph

# Select metabolite columns (start with "x")
metabolite_data <- Corals_clean %>%
  select(starts_with("x"))

# Calculate ubiquity (% samples with metabolite present) and abundance (sum)
metabolite_summary <- metabolite_data %>%
  pivot_longer(
    cols = everything(),
    names_to = "metabolite",
    values_to = "value"
  ) %>%
  group_by(metabolite) %>%
  summarise(
    ubiquity = mean(value > 0) * 100,   # percent of samples where present
    abundance = sum(value, na.rm = TRUE),  # total abundance
    .groups = "drop"
  )

# Scatter plot
ggplot(metabolite_summary, aes(x = ubiquity, y = abundance)) +
  geom_point(alpha = 0.7) +
  theme_minimal(base_size = 14) +
  labs(
    x = "Ubiquity (% samples present)",
    y = "Total abundance",
    title = "Metabolite ubiquity vs total abundance"
  )
```

```{r}
#| label: Metabolite_ubiquity_vs_average_abundance

# helper: choose a y-axis label function compatible with the installed 'scales' version
y_labels_fn <- if (packageVersion("scales") >= "1.2.0") {
  # new API (scales >= 1.2.0)
  label_number(scale_cut = cut_short_scale())
} else {
  # fallback for older scales
  label_number_si()
}

# Select metabolite columns (start with "x")
metabolite_data <- Corals_clean %>%
  select(starts_with("x"))

# Calculate ubiquity (% samples with metabolite present) and average abundance
metabolite_summary <- metabolite_data %>%
  pivot_longer(
    cols = everything(),
    names_to = "metabolite",
    values_to = "value"
  ) %>%
  group_by(metabolite) %>%
  summarise(
    ubiquity = mean(value > 0) * 100,
    avg_abundance = mean(value, na.rm = TRUE),
    .groups = "drop"
  )

ggplot(metabolite_summary, aes(x = ubiquity, y = avg_abundance)) +
  geom_point(color = "#6d9eeb", alpha = 0.8, size = 2) +  # circles
  scale_y_continuous(labels = y_labels_fn) +
  labs(
    x = "Ubiquity (% samples present)",
    y = "Average abundance",
    title = "Metabolite ubiquity vs average abundance"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    panel.grid.major  = element_line(color = "gray50"),
    panel.grid.minor  = element_blank(),
    plot.title        = element_text(hjust = 0.5, face = "bold", color = "white"),
    axis.title        = element_text(color = "white"),
    axis.text         = element_text(color = "white"),
    axis.line         = element_blank(),   # removes x and y axis lines
    legend.position   = "none"
  )
```

```{r}
#| label: Metabolite_ubiquity_vs_average_abundance_corals

# --- Compute presence / ubiquity overall and within coral samples ---
met_presence_long <- Corals_clean %>%
  pivot_longer(
    cols = starts_with("x"),
    names_to = "metabolite",
    values_to = "value"
  ) %>%
  mutate(present = value > 0)

ubiquity_overall <- met_presence_long %>%
  group_by(metabolite) %>%
  summarise(ubiquity_all = mean(present) * 100, .groups = "drop")

ubiquity_corals <- met_presence_long %>%
  filter(host_order == "Scleractinia") %>%
  group_by(metabolite) %>%
  summarise(ubiquity_coral = mean(present) * 100, .groups = "drop")

met_summary <- ubiquity_overall %>%
  left_join(ubiquity_corals, by = "metabolite") %>%
  mutate(ubiquity_coral = ifelse(is.na(ubiquity_coral), 0, ubiquity_coral))

coral_present <- met_presence_long %>%
  filter(host_order == "Scleractinia", present) %>%
  distinct(metabolite)

noncoral_present <- met_presence_long %>%
  filter(host_order != "Scleractinia", present) %>%
  distinct(metabolite)

coral_only <- setdiff(coral_present$metabolite, noncoral_present$metabolite)

met_summary <- met_summary %>%
  left_join(
    met_presence_long %>%
      group_by(metabolite) %>%
      summarise(avg_abundance = mean(value, na.rm = TRUE), .groups = "drop"),
    by = "metabolite"
  ) %>%
  mutate(category = ifelse(metabolite %in% coral_only, "Coral-only", "Other"))

# --- compute x position for vertical line (max overall ubiquity among coral-only mets) ---
x_vline_pos <- met_summary %>%
  filter(category == "Coral-only") %>%
  pull(ubiquity_all) %>%
  { if(length(.) == 0) NA_real_ else max(., na.rm = TRUE) }

# --- Plot: map fill to category so legend is generated; use override.aes to force legend key fills ---
ggplot(met_summary, aes(x = ubiquity_all, y = avg_abundance, fill = category)) +
  geom_point(
    data = subset(met_summary, category == "Other"),
    aes(x = ubiquity_all, y = avg_abundance),
    shape = 21, size = 2.8, color = "white",
    alpha = 0.55, stroke = 0.3, show.legend = TRUE
  ) +
  geom_point(
    data = subset(met_summary, category == "Coral-only"),
    aes(x = ubiquity_all, y = avg_abundance),
    shape = 21, size = 2.8, color = "white",
    alpha = 0.6, stroke = 0.35, show.legend = TRUE
  ) +
  { if (!is.na(x_vline_pos)) geom_vline(xintercept = x_vline_pos, color = "white", linetype = "dashed", linewidth = 0.6) else NULL } +
  scale_fill_manual(
    values = c("Coral-only" = "red", "Other" = "white"),
    breaks = c("Coral-only", "Other"),
    labels = c("Coral-only (Scleractinia)", "Other")
  ) +
  guides(
    fill = guide_legend(
      override.aes = list(
        fill = c("red", "white"),
        color = "white",
        shape = 21,
        size = 4,
        alpha = c(0.6, 0.55),
        stroke = 0.35
      )
    )
  ) +
  # <-- REPLACED LINE: use label_number with scale_cut instead of deprecated label_number_si()
  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale())) +
  scale_x_continuous(
    limits = c(0, 100),
    breaks = seq(0, 100, by = 20),
    labels = as.character(seq(0, 100, by = 20))
  ) +
  labs(
    x = "Ubiquity (% samples present)",
    y = "Average abundance",
    title = "Metabolite ubiquity vs average abundance"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    panel.grid.major  = element_line(color = "gray40"),
    panel.grid.minor  = element_blank(),
    plot.title        = element_text(hjust = 0.5, face = "bold", color = "white"),
    axis.title        = element_text(color = "white"),
    axis.text         = element_text(color = "white"),
    axis.line         = element_blank(),
    legend.position   = "bottom",
    legend.title      = element_blank(),
    legend.text       = element_text(color = "white"),
    legend.background = element_rect(fill = "#000042", color = NA),
    legend.key        = element_rect(fill = "#000042", color = NA)
  )
```

```{r}
#| label: dataset_with_Scleractinia_metabolites

# 1) Long-format presence/values for all samples
met_presence_long <- Corals_clean %>%
  pivot_longer(
    cols = starts_with("x"),
    names_to = "metabolite",
    values_to = "value"
  ) %>%
  mutate(present = value > 0)

# 2) Ubiquity overall (all samples) and ubiquity in corals (Scleractinia)
ubiquity_overall <- met_presence_long %>%
  group_by(metabolite) %>%
  summarise(ubiquity_overall = mean(present) * 100, .groups = "drop")

ubiquity_in_corals <- met_presence_long %>%
  filter(host_order == "Scleractinia") %>%
  group_by(metabolite) %>%
  summarise(
    percent_in_corals = mean(present) * 100,  # percent of coral samples metabolite is found in
    n_corals_present = sum(present),          # number of coral samples with metabolite
    n_corals_total = n(),                     # total coral samples used for denominator
    .groups = "drop"
  )

# 3) Identify metabolites present in non-coral samples
met_in_noncoral <- met_presence_long %>%
  filter(host_order != "Scleractinia", present) %>%
  distinct(metabolite) %>%
  pull(metabolite)

# 4) Coral-specific metabolites = those present in corals and NOT present in non-coral samples
#    (i.e., present at least once in corals AND absent from all non-coral samples)
coral_specific_mets <- ubiquity_in_corals %>%
  filter(percent_in_corals > 0) %>%      # present at least once in corals
  filter(!metabolite %in% met_in_noncoral) %>%
  pull(metabolite)

# 5) Build metabolite-level summary for coral-specific metabolites, ranked by percent_in_corals
met_summary_coral_only <- ubiquity_in_corals %>%
  filter(metabolite %in% coral_specific_mets) %>%
  # add overall ubiquity and average abundance (across all samples)
  left_join(ubiquity_overall, by = "metabolite") %>%
  left_join(
    met_presence_long %>%
      group_by(metabolite) %>%
      summarise(avg_abundance = mean(value, na.rm = TRUE), .groups = "drop"),
    by = "metabolite"
  ) %>%
  # order by percent_in_corals (most -> least)
  arrange(desc(percent_in_corals), desc(avg_abundance)) %>%
  # make percent_in_corals the first column (already is), keep useful columns
  select(percent_in_corals, metabolite, ubiquity_overall, avg_abundance, n_corals_present, n_corals_total)

# 6) Sample-level dataset: all metadata columns for coral samples, plus only the coral-specific metabolite columns
#    (this keeps original Corals_clean metadata intact)
coral_samples_with_coralonly_mets <- Corals_clean %>%
  filter(host_order == "Scleractinia") %>%
  # keep all metadata columns plus only the coral-specific metabolite columns
  select(
    # keep everything that is NOT a metabolite first (assumes metabolite columns start with 'x')
    -starts_with("x"),
    # then add the coral-specific metabolite columns (if any)
    all_of(coral_specific_mets)
  )
```

```{r}
#| label: metabolite_for_sclerictinia_csv

# Save coral-specific metabolite summary as a CSV file
write.csv(
  met_summary_coral_only,
  file = "met_summary_coral_only.csv",
  row.names = FALSE
)
```

## Need ID

```{r}
#| label: install_openlsx

install.packages("openxlsx")
```

```{r}
#| label: excel_for_missing_values_in_raw_data

library(dplyr)
library(stringr)
library(openxlsx)

# columns to check
tax_cols <- c("host_phylum", "host_class", "host_order", "host_genus", "host_species")

# helper function: flag NA or placeholder taxonomy values
is_bad_tax <- function(x) {
  ifelse(
    is.na(x),
    TRUE,
    toupper(str_trim(as.character(x))) %in% c("NA", "UNID", "NAN")
  )
}

# filter rows with bad taxonomy and exclude metabolite columns
problematic_rows <- Corals_raw %>%
  # identify rows where any taxonomy field is bad
  rowwise() %>%
  mutate(.bad_any = any(across(all_of(tax_cols), ~ is_bad_tax(.x)))) %>%
  ungroup() %>%
  filter(.bad_any) %>%
  select(-.bad_any) %>%
  # exclude columns that start with "x"
  select(-starts_with("x"))

# reorder columns: sample first, then taxonomy, then everything else
first_cols <- c("sample", tax_cols)
out_df <- problematic_rows %>%
  select(any_of(first_cols), everything())

# write to Excel
openxlsx::write.xlsx(out_df, "problematic_taxonomy_rows.xlsx", overwrite = TRUE)

```

```{r}
#| label: excel_for_ubiquitous_scleractinia
openxlsx::write.xlsx(met_summary_coral_only, "ubiquitous_scleractinia_metabolites.xlsx")
```

## New data set Richness

```{r}
#Identify metabolite columns (start with "x")
metabolite_cols <- grep("^x", names(Corals_clean), value = TRUE)

# Compute metabolomic richness per sample
# Richness = count of metabolites with intensity > 0
richness_qc <- Corals_clean %>%
  rowwise() %>%
  mutate(MetabolomicRichness = sum(c_across(all_of(metabolite_cols)) > 0, na.rm = TRUE)) %>%
  ungroup()

#brought richness column to front for vizualization 
richness_qc <- richness_qc %>% select(MetabolomicRichness, everything())
```

```{r}
# Calculation to use 1.5 standard deviations below the mean for richness
# Restricting "Low Richness" labels only to the phylum Cnidaria
richness_qc <- richness_qc %>%
  mutate(
    mean_richness = mean(MetabolomicRichness, na.rm = TRUE),
    sd_richness   = sd(MetabolomicRichness, na.rm = TRUE),
    # Define threshold: 1.5 standard deviations below the mean
    threshold = mean_richness - (1.5 * sd_richness), 
    # Label as "Low Richness" ONLY if below threshold AND host_phylum is Cnidaria
    is_outlier = if_else(
      MetabolomicRichness < threshold & host_phylum == "Cnidaria", 
      "Low Richness", 
      "Normal"
    )
  ) %>%
  relocate(MetabolomicRichness, is_outlier, threshold, mean_richness, sd_richness, .before = 1)

# Summary table to see the labels applied
table(richness_qc$is_outlier)
```

-   New dataset: qc_data

    -   Gets rid of 29 outliers with the lowest richness of metabolites (1.5 standards below the mean richness)

```{r}
# Filter the dataframe to remove "Low Richness" samples
qc_data <- richness_qc %>%
  filter(is_outlier != "Low Richness")

# Verify the removal
# This should show 0 "Low Richness" entries
table(qc_data$is_outlier)

# Check how many samples were removed
print(paste("Samples removed:", nrow(richness_qc) - nrow(qc_data)))
```

```{r}
library(readr)

# Save the cleaned dataframe to your working directory
write_csv(qc_data, "qc_data.csv")
```

```{r}
#| label: dataset_with_Scleractinia_metabolites_qc

# 1) Long-format presence/values for all samples
met_presence_long <- qc_data %>%
  pivot_longer(
    cols = starts_with("x"),
    names_to = "metabolite",
    values_to = "value"
  ) %>%
  mutate(present = value > 0)

# 2) Ubiquity overall (all samples) and ubiquity in corals (Scleractinia)
ubiquity_overall <- met_presence_long %>%
  group_by(metabolite) %>%
  summarise(ubiquity_overall = mean(present) * 100, .groups = "drop")

ubiquity_in_corals <- met_presence_long %>%
  filter(host_order == "Scleractinia") %>%
  group_by(metabolite) %>%
  summarise(
    percent_in_corals = mean(present) * 100,  # percent of coral samples metabolite is found in
    n_corals_present = sum(present),          # number of coral samples with metabolite
    n_corals_total = n(),                     # total coral samples used for denominator
    .groups = "drop"
  )

# 3) Identify metabolites present in non-coral samples
met_in_noncoral <- met_presence_long %>%
  filter(host_order != "Scleractinia", present) %>%
  distinct(metabolite) %>%
  pull(metabolite)

# 4) Coral-specific metabolites = those present in corals and NOT present in non-coral samples
#    (i.e., present at least once in corals AND absent from all non-coral samples)
coral_specific_mets <- ubiquity_in_corals %>%
  filter(percent_in_corals > 0) %>%      # present at least once in corals
  filter(!metabolite %in% met_in_noncoral) %>%
  pull(metabolite)

# 5) Build metabolite-level summary for coral-specific metabolites, ranked by percent_in_corals
met_summary_coral_only <- ubiquity_in_corals %>%
  filter(metabolite %in% coral_specific_mets) %>%
  # add overall ubiquity and average abundance (across all samples)
  left_join(ubiquity_overall, by = "metabolite") %>%
  left_join(
    met_presence_long %>%
      group_by(metabolite) %>%
      summarise(avg_abundance = mean(value, na.rm = TRUE), .groups = "drop"),
    by = "metabolite"
  ) %>%
  # order by percent_in_corals (most -> least)
  arrange(desc(percent_in_corals), desc(avg_abundance)) %>%
  # make percent_in_corals the first column (already is), keep useful columns
  select(percent_in_corals, metabolite, ubiquity_overall, avg_abundance, n_corals_present, n_corals_total)

# 6) Sample-level dataset: all metadata columns for coral samples, plus only the coral-specific metabolite columns
#    (this keeps original Corals_clean metadata intact)
coral_samples_with_coralonly_mets <- Corals_clean %>%
  filter(host_order == "Scleractinia") %>%
  # keep all metadata columns plus only the coral-specific metabolite columns
  select(
    # keep everything that is NOT a metabolite first (assumes metabolite columns start with 'x')
    -starts_with("x"),
    # then add the coral-specific metabolite columns (if any)
    all_of(coral_specific_mets)
  )
```

-   New csv: qc_met_summary_scler

    -   Has the uniquley ubiquitous metabolites only found in Scleractinia

        -   "percent_in_corals" = percent that metabolite is found from all Scleractinian samples

        -    "ubiquity_overall" = percent that metabolite is found out of all samples

        -   "n_corals_present" = total amount of Scleractinian samples that metabolite was found in

        -   "n_corals_total" = the total amount of Scleractinian samples present in the dataset

```{r}
#| label: metabolite_for_sclerictinia_csv_qc

# Save coral-specific metabolite summary as a CSV file
write.csv(
  met_summary_coral_only,
  file = "qc_met_summary_scler.csv",
  row.names = FALSE
)
```

```{r}
qc_met_summary_scler <- read.csv("/Users/ellaandonov/World_Corals/Metabolite Summary Data/qc_met_summary_scler.csv")
```

-   New csv: qc_metabolite_ubiquity

    -   Has the overall ubiquity of a metabolite from all the data (not just Scleractinian samples)

```{r}
# Combine the overall ubiquity with average abundance for EVERY metabolite
full_metabolite_report <- ubiquity_overall %>%
  left_join(
    met_presence_long %>%
      group_by(metabolite) %>%
      summarise(avg_abundance = mean(value, na.rm = TRUE), .groups = "drop"),
    by = "metabolite"
  ) %>%
  arrange(desc(ubiquity_overall))

# Export this full report
write_csv(full_metabolite_report, "qc_metabolite_ubiquity.csv")
```

```{r}
qc_metabolite_ubiquity <- read.csv("/Users/ellaandonov/World_Corals/Metabolite Summary Data/qc_metabolite_ubiquity.csv")
```

-   Showing counts of classifications in new qc_data

```{r}
# Count unique categories for each taxonomic level
taxonomic_counts <- qc_data %>%
  summarise(across(
    c(host_phylum, host_class, host_order, host_genus, host_species), 
    ~n_distinct(.x, na.rm = TRUE)
  )) %>%
  # Optional: Pivot to long format for a cleaner table view
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Taxonomic_Level", 
    values_to = "Unique_Count"
  )

# View the counts
print(taxonomic_counts)
```

**Testing Dendrograms**

```{r}
avg_metabolite_values_family <- qc_data |>
  group_by(host_family) |> 
  filter(!is.na(host_family)) |> 
  summarise(across(starts_with("x"), mean, na.rm = TRUE)) |>
  ungroup()
```

```{r}
# turn host_family into rownames and create numeric matrix for vegdist
mat_family <- avg_metabolite_values_family %>%
  as.data.frame()                     # ensure data.frame for rownames()
rownames(mat_family) <- mat_family$host_family
mat_family <- mat_family[ , setdiff(names(mat_family), "host_family")]  # drop the column now that it's rownames

mat_family[] <- lapply(mat_family, as.numeric)

mat_family <- mat_family %>%
  mutate_all(~ifelse(is.na(.), 0, .))   # replace NAs with 0s (common for abundance data)
```

```{r}
bray_curtis_family <- vegdist (sqrt (mat_family), method = 'bray') 
# percentage cover data are transformed by square root
cluster.single <- hclust (d = bray_curtis_family, method = 'single')
cluster.complete <- hclust (bray_curtis_family, 'complete')
cluster.average <- hclust (bray_curtis_family, 'average')
```

```{r}
# Set background color for the plot area and device
par(bg = "#000042")               # device background
par(col = "white",                # axis & text color
    col.axis = "white",
    col.lab  = "white",
    col.main = "white",
    col.sub  = "white",
    fg = "white")                 # foreground (box, axes)

# Plot dendrogram with white lines and labels
plot(cluster.average,
     main = "Dendrogram by Family",
     xlab = "Families",
     sub = "",
     cex = 0.6,
     col = "white",               # dendrogram lines
     col.lab = "white",
     col.main = "white",
     col.axis = "white",
     labels = cluster.average$labels,
     col.lab = "white")

# Draw cluster rectangles in white
rect.hclust(cluster.average, k = 10, border = "white", lwd = 2)

```

**Remake Richness Plots**

Original Richness Plot with Corals_clean

```{r}
#| label: Metabolomic_Richness_by_Phylum

# 1) Identify metabolite columns (start with "x")
metabolite_cols <- grep("^x", names(Corals_clean), value = TRUE)

# 2) Compute metabolomic richness per sample
#    Richness = count of metabolites with intensity > 0
richness_df <- Corals_clean %>%
  select(sample_id, host_phylum, all_of(metabolite_cols)) %>%
  rowwise() %>%
  mutate(MetabolomicRichness = sum(c_across(all_of(metabolite_cols)) > 0, na.rm = TRUE)) %>%
  ungroup()

# 3) Build a distinct, readable palette sized to the # of phyla
n_phyla <- n_distinct(na.omit(richness_df$host_phylum))
diverse_palette <- grDevices::colorRampPalette(
  c("#ebf2ff", "#6d9eeb", "#3c78d8",   # blues
    "#a2d9a2", "#3fa34d", "#145214",   # greens
    "#e0c2f2", "#9b59b6", "#4b0082")   # purples
)(n_phyla)

# 4) Box-and-whisker plot (dark background, clear outlines, visible outliers)
ggplot(richness_df, aes(x = host_phylum, y = MetabolomicRichness, fill = host_phylum)) +
  geom_boxplot(color = "white", outlier.colour = "white", outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = diverse_palette) +
  labs(
    title = "Metabolomic Richness by Phylum",
    x = "Phylum",
    y = "Number of Detected Metabolites"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    legend.position   = "none",
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "white"),
    axis.title = element_text(size = 14, color = "white"),
    axis.text  = element_text(size = 12, color = "white"),
    panel.grid.major = element_line(color = "gray40"),
    panel.grid.minor = element_line(color = "gray30")
  )
```

-   New csv: full_outlier_data

    -   Shows the outliers that are in the original Corals_clean richness plot

```{r}
library(dplyr)

# 1. Identify the outliers and keep only their IDs
outlier_ids <- richness_df %>%
  group_by(host_phylum) %>%
  mutate(
    Q1 = quantile(MetabolomicRichness, 0.25, na.rm = TRUE),
    Q3 = quantile(MetabolomicRichness, 0.75, na.rm = TRUE),
    IQR = Q3 - Q1,
    lower_bound = Q1 - (1.5 * IQR),
    upper_bound = Q3 + (1.5 * IQR),
    is_outlier = MetabolomicRichness < lower_bound | MetabolomicRichness > upper_bound
  ) %>%
  filter(is_outlier == TRUE) %>%
  select(sample_id) # Keep only the ID for the join

# 2. Join back to Corals_clean to get ALL original columns
full_outlier_data <- Corals_clean %>%
  inner_join(outlier_ids, by = "sample_id")

# View the full details of the outliers
View(full_outlier_data)
```

-   Showing richness plot for qc_data

```{r}
#| label: Metabolomic_Richness_by_Phylum

# 1) Identify metabolite columns (start with "x")
metabolite_cols_qc <- grep("^x", names(richness_qc_clean), value = TRUE)

# 2) Compute metabolomic richness per sample
#    Richness = count of metabolites with intensity > 0
richness_df_qc <- richness_qc_clean %>%
  select(sample_id, host_phylum, all_of(metabolite_cols_qc)) %>%
  rowwise() %>%
  mutate(MetabolomicRichness = sum(c_across(all_of(metabolite_cols_qc)) > 0, na.rm = TRUE)) %>%
  ungroup()

# 3) Build a distinct, readable palette sized to the # of phyla
n_phyla <- n_distinct(na.omit(richness_df_qc$host_phylum))
diverse_palette <- grDevices::colorRampPalette(
  c("#ebf2ff", "#6d9eeb", "#3c78d8",   # blues
    "#a2d9a2", "#3fa34d", "#145214",   # greens
    "#e0c2f2", "#9b59b6", "#4b0082")   # purples
)(n_phyla)

# 4) Box-and-whisker plot (dark background, clear outlines, visible outliers)
ggplot(richness_df_qc, aes(x = host_phylum, y = MetabolomicRichness, fill = host_phylum)) +
  geom_boxplot(color = "white", outlier.colour = "white", outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = diverse_palette) +
  labs(
    title = "Metabolomic Richness by Phylum",
    x = "Phylum",
    y = "Number of Detected Metabolites"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "#000042", color = NA),
    panel.background  = element_rect(fill = "#000042", color = NA),
    legend.position   = "none",
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "white"),
    axis.title = element_text(size = 14, color = "white"),
    axis.text  = element_text(size = 12, color = "white"),
    panel.grid.major = element_line(color = "gray40"),
    panel.grid.minor = element_line(color = "gray30")
  )
```

-   Which samples represent the \~15% of corals that don't have the unique compounds?¬†

    -   This is using the top ubiquitous Scleractinian metabolite (x40256_908_80758_16_341)

```{r}
library(dplyr)

# 1. Get the name of the metabolite with the highest coral ubiquity
# We assume qc_met_summary_scler is sorted, but this finds it regardless
top_coral_metabolite <- qc_met_summary_scler %>%
  arrange(desc(percent_in_corals)) %>%
  slice(1) %>%
  pull(metabolite)

# 2. Find the Scleractinia samples where this metabolite is MISSING (value == 0)
samples_missing_top_met <- richness_qc_clean %>%
  filter(host_order == "Scleractinia") %>%
  # Filter for where the top metabolite intensity is 0
  filter(!!sym(top_coral_metabolite) == 0) %>%
  # Keep metadata columns to identify these samples (adjust column names as needed)
  select(sample_id, host_phylum, host_order, host_family, host_genus, all_of(top_coral_metabolite))

# 3. View the list
print(samples_missing_top_met)
```

-   This is using the top 5 ubiquitous Scleractinian metabolites

```{r}
# Get the top 5 metabolites
top_5_mets <- qc_met_summary_scler %>%
  arrange(desc(percent_in_corals)) %>%
  head(5) %>%
  pull(metabolite)

# Find samples missing ANY of the top 5
samples_missing_any <- richness_qc_clean %>%
  filter(host_order == "Scleractinia") %>%
  rowwise() %>%
  filter(any(c_across(all_of(top_5_mets)) == 0))

View(samples_missing_any)
```

**PERMANOVA for qc_data by Phylum**

```{r}
#| label: permanova_phylum_qc

# Select only numeric metabolite columns
permanova_numeric_data_qc <- richness_qc_clean[, sapply(richness_qc_clean, is.numeric)]

# Compute Bray-Curtis distance
bray_curtis <- vegdist(permanova_numeric_data_qc, method = "bray")

# Run PERMANOVA
phylum_permanova_result_qc <- adonis2(bray_curtis ~ host_phylum, data = richness_qc_clean, permutations = 999)

# Display results
print(phylum_permanova_result_qc)
```

PCoA for qc_data by Phylum

```{r}
#| label: PCoA_phylum_confidence_ellipses_qc

# Select metabolite columns (columns starting with "x")
met_cols <- grep("^x", names(richness_qc_clean), value = TRUE)

# numeric matrix of metabolite abundances (same selection as PERMANOVA)
met_mat <- as.matrix(richness_qc_clean[, met_cols])
mode(met_mat) <- "numeric"

# Bray‚ÄìCurtis distance calculated from numeric abundances (same as PERMANOVA)
bc_dist <- vegdist(met_mat, method = "bray")

# --- PCoA (classical MDS)
pcoa <- cmdscale(bc_dist, eig = TRUE, k = 2)

# calculate percent variance explained (only positive eigenvalues)
pos_eigs <- pcoa$eig[pcoa$eig > 0]
var_explained <- round(100 * pcoa$eig[1:2] / sum(pos_eigs), 1)

# build plotting data frame (keep row order consistent with met_mat / bc_dist)
pcoa_points_phylum <- data.frame(
  PCoA1 = pcoa$points[, 1],
  PCoA2 = pcoa$points[, 2],
  host_phylum = richness_qc_clean$host_phylum,
  row.names = rownames(richness_qc_clean)
)

# --- helper for ellipse computation (unchanged)
veganCovEllipse <- function(cov, center, scale = 1, npoints = 100) {
  theta <- seq(0, 2 * pi, length.out = npoints)
  circle <- cbind(cos(theta), sin(theta))
  ed <- eigen(cov)
  vect <- ed$vectors %*% diag(sqrt(ed$values)) %*% t(circle) * scale
  t(vect + center)
}

# compute ellipses per host_phylum
ellipses_df <- do.call(rbind, lapply(unique(na.omit(pcoa_points_phylum$host_phylum)), function(g) {
  pts <- subset(pcoa_points_phylum, host_phylum == g)[, c("PCoA1", "PCoA2")]
  if (nrow(pts) < 3) return(NULL)
  cov_mat <- cov(pts)
  center <- colMeans(pts)
  el <- veganCovEllipse(cov_mat, center, scale = sqrt(qchisq(0.95, df = 2)), npoints = 200)
  data.frame(PCoA1 = el[, 1], PCoA2 = el[, 2], host_phylum = g)
}))

# --- Plot
ggplot(pcoa_points_phylum, aes(x = PCoA1, y = PCoA2, color = host_phylum)) +
  geom_point(size = 3, alpha = 0.8) +
  geom_polygon(data = ellipses_df,
               aes(x = PCoA1, y = PCoA2, fill = host_phylum),
               alpha = 0.15, colour = NA) +
  labs(
    x = paste0("PCoA 1 (", var_explained[1], "%)"),
    y = paste0("PCoA 2 (", var_explained[2], "%)"),
    title = "PCoA of Bray‚ÄìCurtis Dissimilarity by Phylum",
    color = "Phylum",
    fill = "Phylum"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "right")
```

PCoA for qc_data by Family

```{r}
library(dplyr)
library(vegan)
library(ggplot2)

# 1) Filter dataset for Scleractinia only & remove families with < 3 samples
scler_data <- richness_qc_clean %>%
  filter(host_order == "Scleractinia") %>%
  group_by(host_family) %>%
  filter(n() >= 3) %>%
  ungroup()

# 2) Identify metabolite columns and create distance matrix
met_cols <- grep("^x", names(scler_data), value = TRUE)
met_mat <- as.matrix(scler_data[, met_cols])
mode(met_mat) <- "numeric"

# Bray‚ÄìCurtis distance
bc_dist <- vegdist(met_mat, method = "bray")

# 3) PCoA (classical MDS)
pcoa <- cmdscale(bc_dist, eig = TRUE, k = 2)
var_explained <- round(100 * pcoa$eig[1:2] / sum(pcoa$eig[pcoa$eig > 0]), 1)

# 4) Build data frame for individual points
pcoa_points <- data.frame(
  PCoA1 = pcoa$points[, 1],
  PCoA2 = pcoa$points[, 2],
  host_family = scler_data$host_family
)

# 5) Calculate Centroids
family_centroids <- pcoa_points %>%
  group_by(host_family) %>%
  summarise(PCoA1 = mean(PCoA1), PCoA2 = mean(PCoA2), .groups = "drop")

# 6) Compute ellipses
ellipses_df <- do.call(rbind, lapply(unique(pcoa_points$host_family), function(g) {
  pts <- subset(pcoa_points, host_family == g)[, c("PCoA1", "PCoA2")]
  cov_mat <- cov(pts)
  center <- colMeans(pts)
  el <- veganCovEllipse(cov_mat, center, scale = sqrt(qchisq(0.95, df = 2)), npoints = 200)
  data.frame(PCoA1 = el[, 1], PCoA2 = el[, 2], host_family = g)
}))

# 7) Plot
ggplot(family_centroids, aes(x = PCoA1, y = PCoA2, color = host_family)) +
  # Confidence Ellipses (95%)
  geom_polygon(data = ellipses_df, aes(fill = host_family), alpha = 0.15, linetype = 1) +
  # Centroid Points
  geom_point(size = 4) +
  labs(
    x = paste0("PCoA 1 (", var_explained[1], "%)"),
    y = paste0("PCoA 2 (", var_explained[2], "%)"),
    title = "Metabolomic PCoA: Scleractinia Family Clusters",
    subtitle = "Centroids and 95% Confidence Ellipses (Bray-Curtis)",
    color = "Host Family",
    fill = "Host Family"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "right",
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold")
  )
```
