---
title: "PERMANOVA"
format: html
---

## Library and Data

```{r}
#| label: library_load

library(tidyverse)
library(knitr)
library(readxl)
library(data.table)
library(vegan)
```

```{r}
#| label: read_csvs

Corals_raw <- read_excel("Corals_raw.xlsx")
ITS2 <- read.csv("ITS2.csv")
Corals_clean <- read.csv("Corals_clean.csv")
ITS2_clean   <- read.csv("ITS2_clean.csv")
met_summary_coral_only <- read.csv("met_summary_coral_only.csv")
```

## PERMANOVAs and PCoAs per metadata

```{r}
#| label: permanova_phylum

# Select only numeric metabolite columns
permanova_numeric_data <- Corals_clean[, sapply(Corals_clean, is.numeric)]

# Compute Bray-Curtis distance
bray_curtis <- vegdist(permanova_numeric_data, method = "bray")

# Run PERMANOVA
phylum_permanova_result <- adonis2(bray_curtis ~ host_phylum, data = Corals_clean, permutations = 999)

# Display results
print(phylum_permanova_result)
```

```{r}
#| label: PCoA_phylum_confidence_ellipses

# helper to compute ellipse points from covariance matrix
veganCovEllipse <- function (cov, center, scale = 1, npoints = 100) {
  theta <- (0:npoints) * 2 * pi / npoints
  circle <- cbind(cos(theta), sin(theta))
  # scale by eigen decomposition of covariance
  ed <- eigen(cov)
  vect <- ed$vectors %*% diag(sqrt(ed$values)) %*% t(circle) * scale
  t(vect + center)
}

# compute group-specific ellipses
groups <- unique(pcoa_points_phylum$host_phylum)
ellipses_df <- do.call(rbind, lapply(groups, function(g) {
  pts <- subset(pcoa_points_phylum, host_phylum == g)[, c("PCoA1", "PCoA2")]
  if(nrow(pts) < 3) return(NULL)  # can't compute covariance with <3 pts
  cov_mat <- cov(pts)
  center <- colMeans(pts)
  el <- veganCovEllipse(cov_mat, center, scale = sqrt(qchisq(0.95, df = 2)), npoints = 200)
  data.frame(PCoA1 = el[,1], PCoA2 = el[,2], host_phylum = g)
}))

# Plot points + ellipses (vegan style)
ggplot(pcoa_points_phylum, aes(x = PCoA1, y = PCoA2, color = host_phylum)) +
  geom_point(size = 3, alpha = 0.8) +
  geom_polygon(data = ellipses_df, aes(x = PCoA1, y = PCoA2, fill = host_phylum),
               alpha = 0.15, colour = NA) +
  labs(
    x = paste0("PCoA 1 (", var_explained[1], "%)"),
    y = paste0("PCoA 2 (", var_explained[2], "%)"),
    title = "PCoA of Bray–Curtis Dissimilarity by Phylum"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "right")
```

```{r}
#| label: permanova_location

# 1) select numeric columns (metabolites)
permanova_numeric_data <- Corals_clean[, sapply(Corals_clean, is.numeric)]

# 2) find rows with non-missing location AND non-missing numeric values
keep_rows <- !is.na(Corals_clean$location) &
             apply(permanova_numeric_data, 1, function(x) !any(is.na(x)))

# 3) subset both data objects
permanova_numeric_data2 <- permanova_numeric_data[keep_rows, , drop = FALSE]
meta2 <- Corals_clean[keep_rows, , drop = FALSE]

# 4) compute Bray-Curtis on the filtered numeric table
bray_curtis2 <- vegdist(permanova_numeric_data2, method = "bray")

# 5) run PERMANOVA with matching metadata
phylum_permanova_result <- adonis2(bray_curtis2 ~ location, data = meta2, permutations = 999)

# 6) show result
print(phylum_permanova_result)
```

```{r}
#| label: PCoA_location

#  PCoA (Principal Coordinates Analysis)
pcoa_result <- cmdscale(bray_curtis, eig = TRUE, k = 2)

# Extract coordinates
pcoa_points <- as.data.frame(pcoa_result$points)
colnames(pcoa_points) <- c("PCoA1", "PCoA2")

# Combine coordinates with metadata
pcoa_points <- cbind(pcoa_points, meta_data)

# Percent variance explained by first two axes
pos_eig <- pcoa_result$eig[pcoa_result$eig > 0]
var_explained <- round(100 * pcoa_result$eig[1:2] / sum(pos_eig), 1)

#  Plot with 95% confidence ellipses
ggplot(pcoa_points, aes(x = PCoA1, y = PCoA2, color = location, fill = location)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.15, level = 0.95, type = "t", colour = NA) +
  labs(
    title = "PCoA of Bray–Curtis Dissimilarity by Location",
    x = paste0("PCoA 1 (", var_explained[1], "%)"),
    y = paste0("PCoA 2 (", var_explained[2], "%)")
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "right",
    panel.grid = element_blank(),
    plot.title = element_text(face = "bold")
  )
```

```{r}
#| label: permanova_bleaching

# Select only numeric columns (assumed metabolites)
permanova_numeric_data <- Corals_clean[, sapply(Corals_clean, is.numeric)]

# Build logical mask: non-missing bleaching, no NA in numeric data, and not all zeros
mask_non_missing_meta <- !is.na(Corals_clean$bleaching)
mask_no_numeric_NA <- apply(permanova_numeric_data, 1, function(x) !any(is.na(x)))
mask_not_all_zero <- rowSums(permanova_numeric_data, na.rm = TRUE) > 0

keep_rows <- mask_non_missing_meta & mask_no_numeric_NA & mask_not_all_zero

# Subset numeric table and metadata to matching rows
permanova_numeric_data2 <- permanova_numeric_data[keep_rows, , drop = FALSE]
meta2 <- Corals_clean[keep_rows, , drop = FALSE]

# Compute Bray–Curtis distance on filtered numeric data
bray_curtis2 <- vegdist(permanova_numeric_data2, method = "bray")

# Run PERMANOVA (bleaching)
bleaching_permanova_result <- adonis2(bray_curtis2 ~ bleaching, data = meta2, permutations = 999)

print(bleaching_permanova_result)
```

```{r}
#| label: PCoA_bleaching

# PCoA (cmdscale) and percent variance explained
pcoa_result <- cmdscale(bray_curtis2, eig = TRUE, k = 2)
pcoa_points <- as.data.frame(pcoa_result$points)
colnames(pcoa_points) <- c("PCoA1", "PCoA2")
pcoa_points <- bind_cols(pcoa_points, meta2)

pos_eig <- pcoa_result$eig[pcoa_result$eig > 0]
var_explained <- round(100 * pcoa_result$eig[1:2] / sum(pos_eig), 1)

# Plot with 95% confidence ellipses
p <- ggplot(pcoa_points, aes(x = PCoA1, y = PCoA2, color = bleaching, fill = bleaching)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.15, level = 0.95, type = "t", colour = NA) +
  labs(
    title = "PCoA of Bray–Curtis Dissimilarity by Bleaching Status",
    x = paste0("PCoA1 (", var_explained[1], "%)"),
    y = paste0("PCoA2 (", var_explained[2], "%)")
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "right")

print(p)
```

```{r}
#| label: permanova_symbiont_potential

# Select numeric columns (assumed metabolites)
permanova_numeric_data <- Corals_clean[, sapply(Corals_clean, is.numeric)]

# Build mask: non-missing predictor, no NA in numeric columns, not all zeros
mask_non_missing_predictor <- !is.na(Corals_clean$symbiont.potential)
mask_no_numeric_NA <- apply(permanova_numeric_data, 1, function(x) !any(is.na(x)))
mask_not_all_zero <- rowSums(permanova_numeric_data, na.rm = TRUE) > 0

keep_rows <- mask_non_missing_predictor & mask_no_numeric_NA & mask_not_all_zero

# Subset numeric table and metadata (ensure same order)
permanova_numeric_data2 <- permanova_numeric_data[keep_rows, , drop = FALSE]
meta2 <- Corals_clean[keep_rows, , drop = FALSE]

# Compute Bray–Curtis on filtered numeric data
bray_curtis2 <- vegdist(permanova_numeric_data2, method = "bray")

# Run PERMANOVA (symbiont.potential)
symbiont_permanova_result <- adonis2(bray_curtis2 ~ symbiont.potential, data = meta2, permutations = 999)

print(symbiont_permanova_result)
```

```{r}
#| label: PCoA_symbiont_potential

# PCoA and 95% confidence ellipses for visualization
pcoa_result <- cmdscale(bray_curtis2, eig = TRUE, k = 2)
pcoa_points <- as.data.frame(pcoa_result$points)
colnames(pcoa_points) <- c("PCoA1", "PCoA2")
pcoa_points <- bind_cols(pcoa_points, meta2)

# positive eigenvalues for % variance
pos_eig <- pcoa_result$eig[pcoa_result$eig > 0]
var_explained <- round(100 * pcoa_result$eig[1:2] / sum(pos_eig), 1)

ggplot(pcoa_points, aes(x = PCoA1, y = PCoA2, color = symbiont.potential, fill = symbiont.potential)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.15, level = 0.95, type = "t", colour = NA) +
  labs(
    title = "PCoA of Bray–Curtis by symbiont.potential",
    x = paste0("PCoA1 (", var_explained[1], "%)"),
    y = paste0("PCoA2 (", var_explained[2], "%)")
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "right")
```

## PERMANOVA for Scleractinia 

```{r}
#| label: Scleractinia_only_df

Scleractinia_only <- Corals_clean[Corals_clean$host_order == "Scleractinia", ]
```

```{r}
#| label: Scleractinia_family_PERMANOVA

# Remove rows with any NA values in numeric columns
permanova_scl_numeric_data <- na.omit(permanova_scl_numeric_data)

# Recompute Bray-Curtis distance
bray_curtis <- vegdist(permanova_scl_numeric_data, method = "bray")

# Make sure host_family matches the remaining rows
family_permanova_result <- adonis2(
  bray_curtis ~ host_family,
  data = Scleractinia_only[rownames(permanova_scl_numeric_data), ],
  permutations = 999
)

print(family_permanova_result)
```

```{r}
#| label: PCoA_family

# Perform PCoA 
pcoa_res <- cmdscale(as.dist(bray_curtis), eig = TRUE, k = 2)

# Build plotting dataframe (assumes distance matrix has rownames matching Scleractinia_only)
sample_ids <- rownames(as.matrix(bray_curtis))
coords <- as.data.frame(pcoa_res$points[, 1:2])
colnames(coords) <- c("Axis1", "Axis2")
pcoa_df <- data.frame(Sample = sample_ids,
                      Axis1 = coords$Axis1,
                      Axis2 = coords$Axis2,
                      host_family = as.factor(Scleractinia_only[sample_ids, "host_family"]),
                      row.names = sample_ids)

# % variance explained (use positive eigenvalues)
eig <- pcoa_res$eig
pos_sum <- sum(eig[eig > 0])
var_explained <- if (pos_sum > 0) round(100 * eig / pos_sum, 1) else round(100 * eig / sum(abs(eig)), 1)

# Plot
ggplot(pcoa_df, aes(x = Axis1, y = Axis2, color = host_family, fill = host_family)) +
  geom_point(size = 3) +
  stat_ellipse(type = "t", level = 0.95, alpha = 0.2) +
  labs(
    title = "PCoA (Bray-Curtis) — Scleractinia samples",
    x = paste0("PCoA1 (", var_explained[1], "%)"),
    y = paste0("PCoA2 (", var_explained[2], "%)")
  ) +
  theme_minimal()

```

```{r}
#| label: Scleractinia_genus_PERMANOVA

# Remove rows with any NA values in numeric columns
permanova_scl_numeric_data <- na.omit(permanova_scl_numeric_data)

# Recompute Bray-Curtis distance
bray_curtis <- vegdist(permanova_scl_numeric_data, method = "bray")

# Make sure host_family matches the remaining rows
family_permanova_result <- adonis2(
  bray_curtis ~ host_genus,
  data = Scleractinia_only[rownames(permanova_scl_numeric_data), ],
  permutations = 999
)

print(family_permanova_result)
```

```{r}
#| label: PCoA_genus

# Perform PCoA 
pcoa_res <- cmdscale(as.dist(bray_curtis), eig = TRUE, k = 2)

# Build plotting dataframe (assumes distance matrix has rownames matching Scleractinia_only)
sample_ids <- rownames(as.matrix(bray_curtis))
coords <- as.data.frame(pcoa_res$points[, 1:2])
colnames(coords) <- c("Axis1", "Axis2")
pcoa_df <- data.frame(Sample = sample_ids,
                      Axis1 = coords$Axis1,
                      Axis2 = coords$Axis2,
                      host_family = as.factor(Scleractinia_only[sample_ids, "host_genus"]),
                      row.names = sample_ids)

# % variance explained (use positive eigenvalues)
eig <- pcoa_res$eig
pos_sum <- sum(eig[eig > 0])
var_explained <- if (pos_sum > 0) round(100 * eig / pos_sum, 1) else round(100 * eig / sum(abs(eig)), 1)

# Plot
ggplot(pcoa_df, aes(x = Axis1, y = Axis2, color = host_genus, fill = host_genus)) +
  geom_point(size = 3) +
  stat_ellipse(type = "t", level = 0.95, alpha = 0.2) +
  labs(
    title = "PCoA (Bray-Curtis) — Scleractinia samples",
    x = paste0("PCoA1 (", var_explained[1], "%)"),
    y = paste0("PCoA2 (", var_explained[2], "%)")
  ) +
  theme_minimal()

```

## General PERMANOVA for Corals vs other

```{r}
#| label: PCoA_plot_based_on_Jaccard_distances

pcoa <- cmdscale(jaccard_dist, eig = TRUE, k = 2)
plot_df <- data.frame(
  Axis1 = pcoa$points[,1],
  Axis2 = pcoa$points[,2],
  group = df$group_hexocto
)

ggplot(plot_df, aes(x = Axis1, y = Axis2, color = group)) +
  geom_point(size = 3, alpha = 0.7) +
  theme_minimal(base_size = 14) +
  labs(title = "PCoA of Metabolite Presence (Jaccard)",
       subtitle = "Hexacorallia + Octocorallia vs Other",
       x = "PCoA Axis 1", y = "PCoA Axis 2")

```

```{r}
# PCoA plot of metabolite abundances (Hellinger + Bray–Curtis)
library(ggplot2)

# PCoA on Bray–Curtis distance
pcoa <- cmdscale(bc_dist, eig = TRUE, k = 2)

# Build plotting dataframe
plot_df <- data.frame(
  Axis1 = pcoa$points[, 1],
  Axis2 = pcoa$points[, 2],
  group = df_sub$group_hexocto
)

# Percent variance explained by first two axes
var_expl <- round(100 * pcoa$eig[1:2] / sum(pcoa$eig[pcoa$eig > 0]), 1)

# Plot
ggplot(plot_df, aes(x = Axis1, y = Axis2, color = group)) +
  geom_point(size = 3, alpha = 0.8) +
  theme_minimal(base_size = 14) +
  labs(
    title = "PCoA of Metabolite Abundances (Bray–Curtis)",
    x = paste0("PCoA1 (", var_expl[1], "%)"),
    y = paste0("PCoA2 (", var_expl[2], "%)"),
    color = "Group"
  ) +
  stat_ellipse(level = 0.95, linetype = "dashed")

```
