---
title: "Data Wrangling"
format: html
editor: visual
---

## Packages and Data

```{r}
# install.packages("data.table")
# install.packages("dplyr")
```

```{r}
library(tidyverse)
library(knitr)
library(readxl)
library(data.table)
library(dplyr)
```

```{r}
Corals_raw <- read_excel("Corals_raw.xlsx")
ITS2 <- read.csv("ITS2.csv")
Ty_super <- read.csv("Ty_superset_data_raw_KB.csv")
```

## Classification Table Code

```{r}
  
fields <- c(
  "sample", "run", "plate", "dataset", "type", "location", "sample_id", "host_phylum",
  "host_class", "host_order", "host_family", "host_genus", "host_species", "bleaching",
  "symbiont.potential", "individual.symbiosis", "ITS2.type.profile", "X",
  "ITS2_host_species", "ITS2_host_genus", "ITS2_phenotype", "ITS2_Tag", "ITS2Type",
  "ITS2Type1", "ITS2Type2", "ITS2Type3", "ITS2.Letter", "ITS2Genus", "Sequences"
  )

# Subset dataframe to relevant fields
dt_subset <- Ty_superset_data_raw_KB %>%
  select(all_of(fields))

# Create summary table with each field as a row
summary_table <- tibble(
  Metadata = fields,
  Richness = map_int(dt_subset, ~ n_distinct(., na.rm = TRUE)),
  Present  = map_int(dt_subset, ~ sum(!is.na(.)))
)

print(summary_table)

```

```{r}
# 1. Clean up host_phylum
Corals_clean <- Corals_raw %>%
  dplyr::mutate(
    host_phylum = trimws(host_phylum),                  # remove whitespace
    host_phylum = ifelse(host_phylum %in% c("UnID", "Nan"), NA, host_phylum) # set unwanted labels to NA
  ) %>%
  dplyr::filter(!is.na(host_phylum)) # drop NA rows

# 2. Keep only metabolite columns (those not starting with "x")
# Assuming metabolite columns DO start with "x"
metabolite_data <- Corals_clean %>%
  dplyr::select(dplyr::starts_with("x"))

# 3. Make sure data is numeric
metabolite_data <- metabolite_data %>% mutate(across(everything(), as.numeric))

```

```{r}
taxonomy_list <- Corals_clean %>%
  dplyr::select(
    host_phylum, host_class, host_order,
    host_family, host_genus, host_species
  ) %>%
  distinct() %>%
  arrange(
    host_phylum, host_class, host_order,
    host_family, host_genus, host_species
  )

# Print nested taxonomy: Phylum → Class → Order → Family → Genus → Species
for(p in unique(taxonomy_list$host_phylum)) {
  cat("\nPhylum:", p, "\n")
  classes <- taxonomy_list %>%
    filter(host_phylum == p) %>%
    pull(host_class) %>%
    unique() %>%
    na.omit()
  
  for(c in classes) {
    cat("  Class:", c, "\n")
    orders <- taxonomy_list %>%
      filter(host_phylum == p, host_class == c) %>%
      pull(host_order) %>%
      unique() %>%
      na.omit()
    
    for(o in orders) {
      cat("    Order:", o, "\n")
      families <- taxonomy_list %>%
        filter(host_phylum == p, host_class == c, host_order == o) %>%
        pull(host_family) %>%
        unique() %>%
        na.omit()
      
      for(f in families) {
        cat("      Family:", f, "\n")
        genera <- taxonomy_list %>%
          filter(host_phylum == p, host_class == c, host_order == o, host_family == f) %>%
          pull(host_genus) %>%
          unique() %>%
          na.omit()
        
        for(g in genera) {
          cat("        Genus:", g, "\n")
          species <- taxonomy_list %>%
            filter(
              host_phylum == p, host_class == c,
              host_order == o, host_family == f,
              host_genus == g
            ) %>%
            pull(host_species) %>%
            unique() %>%
            na.omit()
          
          for(s in species) {
            cat("          Species:", s, "\n")
          }
        }
      }
    }
  }
}


```

```{r}
library(dplyr)

# Build a taxonomy dataframe with all available levels
taxonomy_df <- Corals_clean %>%
  dplyr::select(
    host_phylum,
    host_class,
    host_order,
    host_family,
    host_genus,
    host_species
  ) %>%
  distinct() %>%   # keep only unique combinations
  arrange(
    host_phylum,
    host_class,
    host_order,
    host_family,
    host_genus,
    host_species
  )

```
